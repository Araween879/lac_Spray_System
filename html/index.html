<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gang Spray Paint Editor</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    
    <!-- ✅ FIX: Inline CSS um SOFORTIGES Verstecken zu garantieren -->
    <style>
        /* BULLETPROOF HIDE - Alle UI-Elemente sofort verstecken */
        .modal, #template-selector, #url-input-modal, #spray-editor, #error-modal, #loading-overlay, .notification, .performance-overlay {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            z-index: -9999 !important;
        }
        
        /* Verhindere automatische Fullscreen-Overlays */
        body.auto-prevent {
            overflow: hidden;
        }
        
        body.auto-prevent::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent;
            z-index: -9998;
            pointer-events: none;
        }
    </style>
</head>
<body class="auto-prevent">
    <!-- ✅ FIX: Template Selector Modal - GARANTIERT VERSTECKT -->
    <div id="template-selector" class="modal hidden" style="display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-images"></i> Template auswählen</h2>
                <button class="close-btn" onclick="closeTemplateSelector()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Category Filter -->
            <div class="template-categories">
                <button class="category-btn active" data-category="all">Alle</button>
                <button class="category-btn" data-category="logo">Logos</button>
                <button class="category-btn" data-category="territory">Territory</button>
                <button class="category-btn" data-category="warning">Warnungen</button>
                <button class="category-btn" data-category="tag">Tags</button>
                <button class="category-btn" data-category="unity">Einheit</button>
                <button class="category-btn" data-category="power">Macht</button>
            </div>
            
            <!-- Template Grid -->
            <div class="template-grid" id="template-grid">
                <!-- Templates werden dynamisch geladen -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTemplateSelector()">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
                <button class="btn btn-secondary" onclick="openCustomEditor()">
                    <i class="fas fa-paintbrush"></i> Custom Editor
                </button>
                <button class="btn btn-secondary" onclick="openUrlInput()">
                    <i class="fas fa-link"></i> URL verwenden
                </button>
                <button class="btn btn-primary" id="use-template-btn" disabled>
                    <i class="fas fa-check"></i> Template verwenden
                </button>
            </div>
        </div>
    </div>

    <!-- ✅ FIX: URL Input Modal - GARANTIERT VERSTECKT -->
    <div id="url-input-modal" class="modal hidden" style="display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-link"></i> Bild von URL laden</h2>
                <button class="close-btn" onclick="closeUrlInput()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="url-input-form">
                <div class="form-group">
                    <label for="image-url">Bild-URL</label>
                    <input type="url" id="image-url" placeholder="https://beispiel.com/bild.png">
                    <small>Unterstützte Formate: PNG, JPG, WebP (max. 5MB)</small>
                </div>
                
                <div class="url-preview" id="url-preview">
                    <img id="preview-image" class="hidden" alt="Vorschau">
                    <div class="preview-info hidden" id="preview-info">
                        <span id="image-dimensions"></span>
                        <span id="image-size"></span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeUrlInput()">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
                <button class="btn btn-info" onclick="previewUrl()">
                    <i class="fas fa-eye"></i> Vorschau
                </button>
                <button class="btn btn-primary" onclick="useUrlImage()" disabled id="use-url-btn">
                    <i class="fas fa-check"></i> Verwenden
                </button>
            </div>
        </div>
    </div>

    <!-- ✅ FIX: Paint Editor - GARANTIERT VERSTECKT -->
    <div id="spray-editor" class="hidden" style="display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important;">
        <div class="editor-container">
            <!-- Canvas Container -->
            <div class="canvas-container">
                <canvas id="paint-canvas" width="1024" height="1024"></canvas>
                
                <!-- Canvas Overlay für UI -->
                <div class="canvas-overlay">
                    <div class="canvas-info">
                        <span id="canvas-zoom">100%</span>
                        <span id="canvas-coords">0, 0</span>
                    </div>
                </div>
            </div>
            
            <!-- Tools Panel -->
            <div class="tools-panel">
                <!-- Drawing Tools -->
                <div class="tool-group">
                    <h3><i class="fas fa-tools"></i> Werkzeuge</h3>
                    
                    <button id="brush-tool" class="tool-btn active" title="Pinsel">
                        <i class="fas fa-paintbrush"></i>
                    </button>
                    <button id="select-tool" class="tool-btn" title="Auswählen">
                        <i class="fas fa-mouse-pointer"></i>
                    </button>
                    <button id="text-tool" class="tool-btn" title="Text">
                        <i class="fas fa-font"></i>
                    </button>
                    <button id="line-tool" class="tool-btn" title="Linie">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button id="circle-tool" class="tool-btn" title="Kreis">
                        <i class="fas fa-circle"></i>
                    </button>
                    <button id="rect-tool" class="tool-btn" title="Rechteck">
                        <i class="fas fa-square"></i>
                    </button>
                </div>

                <!-- Color Picker -->
                <div class="tool-group">
                    <h3><i class="fas fa-palette"></i> Farben</h3>
                    
                    <div class="color-picker-container">
                        <input type="color" id="color-input" value="#ff0000">
                        
                        <!-- Color Presets -->
                        <div class="color-presets" id="gang-colors">
                            <!-- Gang-spezifische Farben werden hier eingefügt -->
                        </div>
                    </div>
                    
                    <!-- Opacity Control -->
                    <div class="opacity-control">
                        <label for="opacity-slider">Deckkraft</label>
                        <input type="range" id="opacity-slider" min="0" max="100" value="100">
                        <span id="opacity-value">100%</span>
                    </div>
                </div>

                <!-- Brush Settings -->
                <div class="tool-group">
                    <h3><i class="fas fa-paintbrush"></i> Pinsel</h3>
                    
                    <div class="brush-controls">
                        <label for="brush-size">Größe</label>
                        <input type="range" id="brush-size" min="1" max="100" value="20">
                        <span id="brush-size-value">20px</span>
                    </div>
                </div>

                <!-- Text Settings -->
                <div class="tool-group hidden" id="text-settings">
                    <h3><i class="fas fa-font"></i> Text</h3>
                    
                    <div class="text-controls">
                        <label for="font-family">Schriftart</label>
                        <select id="font-family">
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Impact">Impact</option>
                            <option value="Verdana">Verdana</option>
                        </select>
                        
                        <label for="font-size">Größe</label>
                        <input type="range" id="font-size" min="12" max="200" value="48">
                        <span id="font-size-value">48px</span>
                    </div>
                    
                    <div class="text-style-controls">
                        <button class="style-btn" id="bold-btn" title="Fett">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button class="style-btn" id="italic-btn" title="Kursiv">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button class="style-btn" id="underline-btn" title="Unterstreichen">
                            <i class="fas fa-underline"></i>
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="tool-group">
                    <h3><i class="fas fa-cogs"></i> Aktionen</h3>
                    
                    <div class="main-actions">
                        <button class="btn btn-secondary" onclick="undoAction()">
                            <i class="fas fa-undo"></i> Rückgängig
                        </button>
                        <button class="btn btn-secondary" onclick="redoAction()">
                            <i class="fas fa-redo"></i> Wiederholen
                        </button>
                        <button class="btn btn-warning" onclick="clearCanvas()">
                            <i class="fas fa-trash"></i> Löschen
                        </button>
                        <button class="btn btn-info" onclick="loadExternalImage()">
                            <i class="fas fa-upload"></i> Bild laden
                        </button>
                        <button class="btn btn-primary" onclick="saveSpray()">
                            <i class="fas fa-save"></i> Speichern
                        </button>
                        <button class="btn btn-secondary" onclick="cancelEditor()">
                            <i class="fas fa-times"></i> Abbrechen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ FIX: Error Modal - GARANTIERT VERSTECKT -->
    <div id="error-modal" class="modal hidden" style="display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header error">
                <h2><i class="fas fa-exclamation-triangle"></i> Fehler</h2>
                <button class="close-btn" onclick="closeErrorModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="error-content">
                <p id="error-message">Ein unbekannter Fehler ist aufgetreten.</p>
                
                <button class="btn btn-secondary" onclick="toggleErrorDetails()" style="margin-top: 16px;">
                    <i class="fas fa-info-circle"></i> Details anzeigen
                </button>
                
                <div class="error-details hidden" id="error-details">
                    <h4>Technische Details:</h4>
                    <pre id="error-stack"></pre>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeErrorModal()">
                    <i class="fas fa-check"></i> OK
                </button>
            </div>
        </div>
    </div>

    <!-- ✅ FIX: Loading Overlay - GARANTIERT VERSTECKT -->
    <div id="loading-overlay" class="hidden" style="display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Lädt...</p>
        </div>
    </div>

    <!-- ✅ FIX: Notification - GARANTIERT VERSTECKT -->
    <div id="notification" class="notification hidden" style="display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important;">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Aktion erfolgreich!</span>
    </div>

    <!-- ✅ FIX: JavaScript Files mit Anti-Auto-Open Script -->
    <script>
        // ✅ FIX: SOFORTIGES Script um alle UI zu verstecken
        (function() {
            // Alle potentiellen UI-Elemente sofort verstecken
            const hideElements = [
                'template-selector', 'url-input-modal', 'spray-editor', 
                'error-modal', 'loading-overlay', 'notification'
            ];
            
            hideElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('hidden');
                    el.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important;';
                }
            });
            
            // Body Class Management
            document.body.classList.remove('nui-modal-open', 'nui-focus-active');
            
            console.log('[HTML] Immediate UI hide script executed');
        })();
    </script>
    
    <script src="js/spray-editor.js"></script>
    <script src="js/template-manager.js"></script>
    <script src="js/performance-monitor.js"></script>
    
    <script>
        // ✅ FIX: Finaler Sicherheitscheck nach dem Laden aller Scripts
        window.addEventListener('load', function() {
            setTimeout(() => {
                // Nochmals alle UI-Elemente verstecken als finale Sicherheit
                document.querySelectorAll('.modal, #spray-editor, .overlay, .performance-overlay, .notification').forEach(el => {
                    el.classList.add('hidden');
                    el.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important;';
                });
                
                document.body.classList.remove('nui-modal-open', 'nui-focus-active');
                console.log('[HTML] Final UI hide check completed');
            }, 100);
        });
    </script>
</body>
</html>